<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dataset Analytics</title>
  <link rel="stylesheet" href="/static/css/style.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="/static/js/dataset.js"></script>
</head>

<!-- ✅ важливо: НЕ page-search, а page-dataset -->
<body class="page-dataset">
  <div class="wrap">
    <header class="header">
      <div class="header-row">
        <h1>Аналіз датасету</h1>
        <a class="btn-link" href="/">Повернутися до пошуку</a>
      </div>

      <div class="sub">
        Env: <span class="pill">{{ env }}</span>
        <span class="sep">|</span>
        Marketplace: <span class="pill">{{ marketplace }}</span>
        <span class="sep">|</span>
        API: <span class="pill">/api/dataset/*</span>
      </div>
    </header>

    <section class="card">
      <div class="grid" style="grid-template-columns: 2fr 1fr 1fr 1fr;">
        <div class="field">
          <label>Поточний файл</label>
          <input id="dsName" disabled value="loading..." />
          <div class="muted" id="dsMode" style="margin-top:6px;"></div>
        </div>

        <div class="field">
          <label>Колонка (числова) для метрик/гістограми</label>
          <select id="numCol"></select>
          <div class="muted" style="margin-top:6px;">
            Парсинг чисел: <span class="pill">NA/N/A/null/empty/- → пропуск</span>,
            прибираємо <span class="pill">коми/пробіли</span> та символи <span class="pill">$ %</span>.
          </div>
        </div>

        <div class="field">
          <label>Колонка (категорія) для топів</label>
          <select id="catCol"></select>
        </div>

        <div class="field">
          <label>Завантажити CSV</label>
          <input id="uploadFile" type="file" accept=".csv,text/csv" />
          <div class="muted" style="margin-top:6px;">Для user-upload: без обрізання.</div>
        </div>
      </div>

      <div class="actions" style="margin-top:14px;">
        <button type="button" id="reloadBtn">Оновити</button>
        <a class="link" href="/docs" target="_blank" rel="noreferrer">Swagger</a>
      </div>
    </section>

    <section class="card" style="margin-top:16px;">
      <div class="top" style="margin-bottom:10px;">
        <div>
          <h2 style="margin:0;">Метрики</h2>
          <div class="muted" id="dsMeta">—</div>
        </div>
      </div>

      <div class="analytics" id="dsCards" style="display:none;"></div>

      <div class="charts" id="dsCharts" style="display:none; margin-top:14px;">
        <div class="chart-card">
          <div class="muted">Гістограма (обрана числова колонка)</div>
          <canvas id="histChart" height="120"></canvas>
        </div>
        <div class="chart-card">
          <div class="muted">Top-значення (обрана категоріальна колонка)</div>
          <canvas id="topChart" height="120"></canvas>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px;">
      <div class="top" style="margin-bottom:10px;">
        <div>
          <h2 style="margin:0;">Перегляд даних</h2>
          <div class="muted" id="pageInfo">—</div>
        </div>
      </div>

      <div class="table-controls">
        <div class="tc-group">
          <div class="field">
            <label>На сторінку</label>
            <input id="pageSize" type="number" min="10" max="500" value="50" />
          </div>
          <div class="field">
            <label>Сторінка</label>
            <input id="pageNum" type="number" min="1" value="1" />
          </div>
          <div class="tc-actions">
            <button type="button" id="prevBtn">←</button>
            <button type="button" id="nextBtn">→</button>
            <button type="button" id="goBtn">Перейти</button>
          </div>
        </div>

        <div class="tc-group">
          <div class="field">
            <label>Фільтр: колонка</label>
            <select id="filterCol">
              <option value="">(всі колонки)</option>
            </select>
          </div>

          <div class="field" id="filterTextBox">
            <label>Містить</label>
            <input id="filterText" placeholder="напр. iphone / USA / 12.99" />
          </div>

          <div class="field" id="filterMinBox" style="display:none;">
            <label>Min</label>
            <input id="filterMin" placeholder="напр. 3.5" />
          </div>
          <div class="field" id="filterMaxBox" style="display:none;">
            <label>Max</label>
            <input id="filterMax" placeholder="напр. 5" />
          </div>

          <div class="tc-actions">
            <button type="button" id="applyFilterBtn">Застосувати</button>
            <button type="button" id="clearFilterBtn">Очистити</button>
          </div>

          <div class="muted" id="filterHint" style="max-width:520px;">
            Для числових колонок доступний фільтр по діапазону (min/max).
          </div>
        </div>

        <div class="tc-group">
          <div class="tc-actions">
            <button type="button" id="exportFilteredBtn">Експорт фільтру (Excel)</button>
            <button type="button" id="exportReportBtn">Експорт звіту (Excel + графіки)</button>
          </div>
          <div class="muted" style="max-width:520px;">
            Експорт робиться по <b>поточній сторінці</b> таблиці (offset/limit) і по застосованому фільтру.
          </div>
        </div>
      </div>

      <div class="table-wrap" id="tableWrap">
        <table class="table" id="dsTable" style="display:none;">
          <thead><tr id="dsHead"></tr></thead>
          <tbody id="dsBody"></tbody>
        </table>
      </div>

      <div class="muted" id="dsErr" style="display:none; margin-top:10px;"></div>
    </section>
  </div>
</body>
</html>